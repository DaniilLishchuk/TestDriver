#include "testLab.h"
#include <stdio.h>
#include <string.h>

static int testN = 0;
static const struct {const char *const in, *const out;} testInOut[] = {
    { "0\n(((((\n", "syntax error" },
    { "1\n/ DIV 2\n1/0\n", "division by zero" },
    { "1\n* MUL 2\n2*2\n", "4" },
    { "0\nbad input\n", "syntax error" },
    { "1\n* MUL 2\n2.0*2.0\n", "syntax error" },
    { "0\n(1", "syntax error" },
    { "0\n(1)", "1" },
    { "0\n123()\n", "syntax error" },
    { "0\n()123\n", "syntax error" },
    { "3\n* MUL 2\n+ ADD 1\n/ DIV 2\n1*2+3/4\n", "2" },
    { "3\n* MUL 2\n+ ADD 1\n/ DIV 2\n1*(2+3)/4\n", "1" },
    { "1\n/ DIV 2\n1/2/3/4\n", "0" },
    { "2\n* MUL 2\n/ DIV 2\n1*2*3/4\n", "1" },
    { "2\n* MUL 2\n+ ADD 1\n1*2+3*4\n", "14" },
    { "2\n+ ADD 1\n* MUL 2\n1+2*3+4\n", "11" },
    { "4\n+ ADD 1\n* MUL 2\n/ DIV 2\n- SUB 1\n1+3*2/(3-1-2)\n", "division by zero" },
    { "1\n- SUB 1\n1--\n", "syntax error" },
    { "2\n- SUB 1\n* MUL 2\n1-*\n", "syntax error" },
    { "2\n- SUB 1\n* MUL 2\n1-1-*1\n", "syntax error" },
    { "1\n- SUB 1\n--1\n", "syntax error" },
    { "1\n- SUB 1\n11-\n", "syntax error" },
    { "0\n()\n", "syntax error" },
    { "1\n- SUB 1\n(-)\n", "syntax error" },
    { "0\n\n", "syntax error" },
    { "0\n)\n", "syntax error" },
    { "0\n0\n", "0" },
    { "1\n+ ADD 1\n1+1)(\n", "syntax error" },
    { "0\n1 1\n", "syntax error" },
    { "1\n+ ADD 1\n1)+(2\n", "syntax error" },
    { "1\n+ ADD 1\n(1))+((2)\n", "syntax error" },
    { "1\n+ ADD 1\n(1+2))+(3\n", "syntax error" },
    { "0\n1234567890\n", "1234567890" },
    { "0\n(1234567890)\n", "1234567890" },
    { "0\n((1234567890))\n", "1234567890" },
    { "1\n+ ADD 1\n1+23+456+7890\n", "8370" },
    { "1\n- SUB 1\n1-23-456-7890\n", "-8368" },
    { "1\n- SUB 1\n(1)-(23)-(456)-(7890)\n", "-8368" },
    { "2\n- SUB 2\n* MUL 3\n3 * 4 - 2 + 1\n", "syntax error" },
    { "4\n+ ADD 1\n- SUB 1\n* MUL 2\n# ADD 3\n3 * 4 # 6\n", "30" },
    { "4\n$ ADD 3\n@ SUB 2\n& MUL 4\n! ADD 1\n2 & 3 $ 5 @ 1 ! 4\n", "14" },
    { "4\n+ ADD 1\n- SUB 3\n& MUL 4\n! ADD 5\n(54 + 10) ! 5 & 4\n", "276" },
    { "6\n+ ADD 2\n- SUB 2\n* MUL 3\n# ADD 1\n$ ADD 4\n& MUL 5\n(3+2)*(4-1)$(5#2)&2\n","85"},
    { "6\n+ ADD 2\n- SUB 1\n* MUL 3\n@ SUB 2\n! MUL 4\n~ ADD 5\n(7+1)*(2-3@1)+5~(1+1)!2\n", "14" },
    { "7\n^ ADD 1\n@ SUB 2\n- SUB 3\n+ ADD 3\n* MUL 4\n~ ADD 5\n& MUL 6\n"
        "((2+3)*(4-1)+(6@2^1))&(1+1~1)\n", "60" },
    { "10\n+ ADD 3\n- SUB 3\n* MUL 5\n/ SUB 5\n# ADD 2\n@ SUB 1\n$ ADD 4\n"
        "& MUL 6\n~ ADD 7\n! MUL 8\n(5+3)*((2-1)+4@2)#((3+5)"
        "*(6-(2+1)))$(1&2)~((8-3)+2)!2\n", "64" },
    {"30\n+ ADD 2\n- SUB 2\n* MUL 4\n/ SUB 4\n# ADD 1\n@ SUB 1\n$ ADD 3\n& MUL "
    "5\n~ ADD 6\n! MUL 7\nE MUL 3\n^ ADD 4\n> SUB 3\n< ADD 5\n? MUL 6\n: SUB "
    "2\n= ADD 2\n[ MUL 5\n] SUB 3\n{ ADD 4\n} SUB 4\n_ MUL 5\n| ADD 6\n; SUB "
    "5\nA ADD 3\n. MUL 4\n, SUB 2\nB ADD 5\nC MUL 6\nD ADD "
    "7\n(((3+5)*(12-8)#(7*(9-2)))$((15+(7))*(6-(5))&(2+(18-11)))~((23+(9)#(8*("
    "4+1)))*(30+14)$(16*(7-5))#(19+(6-3)))@((42+(31))*(3+(12-(5+8)))#(13+(9-7)"
    ")*(21+(14-10)))$((17+28)*(24-19)&(5+(3-1)))!((31+7)*(8-2))#(14+5)*(11-6)$"
    "((9+(4))*(7-2))~(3+(4-(1+1)))&((12+18)*(9-6))#(14*(5+3))$((10+2)*(7-5))~("
    "8+(3-2))#((15+6)-(8+4))*(13+(2-1))~((2+2)*(4-1))#(7+5)$((6+1)*(2-1))&(5+("
    "3-2))@((8+9)-(2+3))*(4+(5-1))E((77+(23))*(4+18))^(12-(5+7))>((101+29)*("
    "15-8))<((45-7)*(5+2))?((8+14)*(22-19)):((6+11)*(3-1))=((5*7)+(11-3))[(4+"
    "8)-(2*5)]((17+5)*(9-3))}((6+3)-(2*1))_((11+19)*(7-2))|((15+4)-(7+3));(("
    "13+21)*(10-5))A((9+6)-(8+2)).((7*12)+(5-2)),((8+3)-(6*1))B((17+4)*(12-7))"
    "C((14+5)-(9+2)))", "-540407"},
    {"0\n(((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((("
    "(((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((("
    "(((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((("
    "(((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((("
    "(((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((("
    "(((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((("
    "(((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((("
    "(((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((("
    "(((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((("
    "(((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((("
    "(((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((("
    "(((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((("
    "(((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((("
    "(((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((("
    "(((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((("
    "((((((((((((((((((((((((((((((((((((((((\n", "syntax error"},
    {"1\n+ ADD 1\n((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((("
    "((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((("
    "((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((("
    "(((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((99"
    ")+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1"
    ")+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1"
    ")+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1"
    ")+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1"
    ")+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1"
    ")+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1"
    ")+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1"
    ")+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1"
    ")+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1"
    ")+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1"
    ")+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1"
    ")+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)+1)\n", "348"},
    {"1\n+ ADD 1\n1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1"
    "+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+"
    "1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1"
    "+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+"
    "1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1"
    "+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+"
    "1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1"
    "+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+"
    "1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1"
    "+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+"
    "1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1"
    "+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+"
    "1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1"
    "+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+"
    "1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1+1"
    "+1+1+1+1+1+1+1+1+1+1+1+99\n", "598"},
#define TEN(a) a a a a a a a a a a
#define FIFTY(a) TEN(a) TEN(a) TEN(a) TEN(a) TEN(a)
#define TWO_HUNDRED(a) FIFTY(a) FIFTY(a) FIFTY(a) FIFTY(a)
    {"1\n+ ADD 1\n(1" TWO_HUNDRED("+1+1+1") "\n", "syntax error"},
#undef TEN
#undef FIFTY
#undef TWO_HUNDRED
    { "0\n(123)456\n", "syntax error" },
    { "0\n123(456)\n", "syntax error" },
    { "0\n(12)(34)\n", "syntax error" },
    { "1\n+ ADD 1\n(1+40)\n", "41" }
};

static int FeedFromArray(void) {
    FILE* const in = fopen("in.txt", "w+");
    if (in == NULL) {
        printf("can't create in.txt. No space on disk?\n");
        return -1;
    }
    fprintf(in, "%s", testInOut[testN].in);
    fclose(in);
    return 0;
}

static int CheckFromArray(void) {
    FILE* const out = fopen("out.txt", "r");
    if (out == NULL) {
        printf("can't open out.txt\n");
        testN++;
        return -1;
    }
    char buf[128] = {0};
    const char* status = ScanChars(out, sizeof(buf), buf);
    fclose(out);
    if (status == Pass && _strnicmp(testInOut[testN].out, buf, strlen(testInOut[testN].out)) != 0) {
        status = Fail;
    }
    if (status == Pass && HaveGarbageAtTheEnd(out)) {
        status = Fail;
    }
    printf("%s\n", status);
    ++testN;
    return status == Fail;
}

TLabTest GetLabTest(int testIdx) {
    (void)testIdx;
    TLabTest labTest = {FeedFromArray, CheckFromArray};
    return labTest;
}

int GetTestCount(void) {
    return sizeof(testInOut)/sizeof(testInOut[0]);
}

const char* GetTesterName(void) {
    return "Lab 4 Calc";
}

int GetTestTimeout(void) {
    return 3000;
}

size_t GetTestMemoryLimit(void) {
    return MIN_PROCESS_RSS_BYTES;
}
